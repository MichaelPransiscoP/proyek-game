<!DOCTYPE html>
<html>
<head>
  <title>Sudoku Phaser</title>
  <script src="https://cdn.jsdelivr.net/npm/phaser@3/dist/phaser.js"></script>
</head>
<body>

<script>
const SIZE = 9;
const CELL = 50;

let selected = {row:0,col:0};
let cells=[];
let numbers=[];
let solution=[];
let fixedMap=[];
let seconds=0;
let timerText;
let timerEvent;
let sceneRef;
let currentLevel="medium";
let offsetX=0;

/* ================== PHASER CONFIG ================== */
const config={
  type:Phaser.AUTO,
  width:600,
  height:540,
  backgroundColor:"#ffffff",
  scene:{create}
};

new Phaser.Game(config);

/* ================== CREATE ================== */
function create(){
  sceneRef=this;

  const centerX = this.cameras.main.width/2;

  // ===== LEVEL SELECT (ATAS TENGAH) =====
  const select=document.createElement("select");
  select.style.position="absolute";
  select.style.top="15px";
  select.style.left="50%";
  select.style.transform="translateX(-50%)";
  select.style.padding="6px";
  select.style.fontSize="16px";

  select.innerHTML=`
    <option value="easy">Easy</option>
    <option value="medium" selected>Medium</option>
    <option value="hard">Hard</option>
  `;
  document.body.appendChild(select);

  select.onchange=()=>{
    const ok=confirm("Ganti level? Progress kamu akan hilang.");
    if(!ok){
      select.value=currentLevel;
      return;
    }
    currentLevel=select.value;
    loadLevel(currentLevel);
  };

  // ===== TIMER =====
  timerText=this.add.text(centerX,500,"Time: 0s",{
    fontSize:"22px",
    color:"#000"
  }).setOrigin(0.5);

  loadLevel("medium");
}

/* ================== LOAD LEVEL ================== */
function loadLevel(level){

  seconds=0;
  offsetX=(sceneRef.cameras.main.width - SIZE*CELL)/2;

  if(timerEvent) timerEvent.remove();

  numbers=generatePuzzle(level);
  solution=JSON.parse(JSON.stringify(numbers));
  solveBoard(solution);

  // clear old
  cells.flat().forEach(c=>{
    c.rect.destroy();
    c.text.destroy();
  });
  cells=[];
  fixedMap=[];

  // timer
  timerEvent=sceneRef.time.addEvent({
    delay:1000,
    loop:true,
    callback:()=>{
      seconds++;
      timerText.setText("Time: "+seconds+"s");
    }
  });

  // draw board
  for(let r=0;r<SIZE;r++){
    cells[r]=[];
    fixedMap[r]=[];

    for(let c=0;c<SIZE;c++){
      let x=offsetX + c*CELL + CELL/2;
      let y=60 + r*CELL + CELL/2;

      let rect=sceneRef.add.rectangle(x,y,CELL-2,CELL-2,0xf0f0f0)
        .setStrokeStyle(1,0x000000)
        .setInteractive();

      rect.on("pointerdown",()=>{
        selected={row:r,col:c};
        highlight();
      });

      let fixed=numbers[r][c]!==0;
      fixedMap[r][c]=fixed;

      let text=sceneRef.add.text(x,y,numbers[r][c]||"",{
        fontSize:"20px",
        color:"#000"
      }).setOrigin(0.5);

      cells[r][c]={rect,text};
    }
  }

  sceneRef.input.keyboard.removeAllListeners();

  sceneRef.input.keyboard.on("keydown",(e)=>{
    if(fixedMap[selected.row][selected.col]) return;

    let n=parseInt(e.key);

    if(n>=1 && n<=9){
      numbers[selected.row][selected.col]=n;
      cells[selected.row][selected.col].text.setText(n);
      refreshColors();
      checkWin();
    }

    if(e.key==="Backspace"){
      numbers[selected.row][selected.col]=0;
      cells[selected.row][selected.col].text.setText("");
      refreshColors();
    }
  });

  highlight();
  refreshColors();
}

/* ================== UI ================== */
function highlight(){
  for(let r=0;r<SIZE;r++)
    for(let c=0;c<SIZE;c++)
      cells[r][c].rect.setFillStyle(0xf0f0f0);

  cells[selected.row][selected.col].rect.setFillStyle(0xffe066);
}

/* ================== VALIDATION ================== */
function isValid(board,row,col,num){
  for(let c=0;c<9;c++)
    if(c!==col && board[row][c]===num) return false;

  for(let r=0;r<9;r++)
    if(r!==row && board[r][col]===num) return false;

  let sr=Math.floor(row/3)*3;
  let sc=Math.floor(col/3)*3;

  for(let r=sr;r<sr+3;r++)
    for(let c=sc;c<sc+3;c++)
      if((r!==row||c!==col)&&board[r][c]===num) return false;

  return true;
}

function refreshColors(){
  for(let r=0;r<9;r++){
    for(let c=0;c<9;c++){
      let v=numbers[r][c];
      if(v===0) cells[r][c].text.setColor("#000");
      else if(isValid(numbers,r,c,v)) cells[r][c].text.setColor("#000");
      else cells[r][c].text.setColor("#ff0000");
    }
  }
}

/* ================== WIN CHECK ================== */
function checkWin(){
  for(let r=0;r<9;r++)
    for(let c=0;c<9;c++)
      if(numbers[r][c]!==solution[r][c]) return;

  timerEvent.remove();

  sceneRef.add.text(sceneRef.cameras.main.width/2,250,"YOU WIN!",{
    fontSize:"42px",
    color:"#00aa00"
  }).setOrigin(0.5);
}

/* ================== GENERATOR ================== */
function generatePuzzle(level){
  let board=Array.from({length:9},()=>Array(9).fill(0));
  solveBoard(board);

  let remove={easy:35,medium:45,hard:55}[level];

  while(remove>0){
    let r=Math.floor(Math.random()*9);
    let c=Math.floor(Math.random()*9);
    if(board[r][c]!==0){
      board[r][c]=0;
      remove--;
    }
  }
  return board;
}

function solveBoard(board){
  for(let r=0;r<9;r++){
    for(let c=0;c<9;c++){
      if(board[r][c]===0){
        let nums=[1,2,3,4,5,6,7,8,9].sort(()=>Math.random()-0.5);
        for(let n of nums){
          if(isValid(board,r,c,n)){
            board[r][c]=n;
            if(solveBoard(board)) return true;
            board[r][c]=0;
          }
        }
        return false;
      }
    }
  }
  return true;
}
</script>
</body>
</html>
